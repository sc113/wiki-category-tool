## Wiki Category Tool

Инструмент с графическим интерфейсом (PySide6) для работы с категориями и страницами проектов Wikimedia (в первую очередь — Wikipedia). Поддерживает чтение содержимого страниц в TSV, массовую перезапись, создание новых страниц по TSV, а также переименование страниц и перенос содержимого категорий, включая полуавтоматическую обработку параметров шаблонов.

### Основные возможности
- **Авторизация через pywikibot**: хранение `user-config.py`/`user-password.py` в папке `configs/`, использование куки.
- **Чтение (вкладка «Чтение»)**: загрузка списка страниц из текстового поля или файла, получение подкатегорий через API или быстрый переход в PetScan, сохранение результата в `.tsv`.
- **Перезапись (вкладка «Перезапись»)**: массовая замена содержимого страниц по TSV, предпросмотр, единый комментарий, отметка «малая правка».
- **Создание (вкладка «Создание»)**: массовое создание только отсутствующих страниц по TSV (существующие пропускаются), предпросмотр, единый комментарий.
- **Переименование (вкладка «Переименование»)**: переименование страниц с опцией перенаправлений, перенос содержимого категорий (прямые включения и параметры шаблонов), диалоги подтверждения, кэш правил замен шаблонов в `configs/template_rules.json`.
- **Работа с префиксами/пространствами имён**: «Авто» (не меняет входные заголовки) или нормализация к выбранному NS; поддержка локальных префиксов и английских алиасов; кэш префиксов в `configs/apicache`.
- **Rate limiting и повторы**: адаптивные паузы при 429/таймаутах, аккуратные повторы при сохранениях.
- **Проверка обновлений**: запрос к GitHub Releases (можно отключить/игнорировать).

## Быстрый старт

### Зависимости и запуск (кратко)
- Python 3.10+; зависимости: `PySide6`, `pywikibot`, `requests`
- Запуск: `python -m wiki_cat_tool`
- Для Windows есть портативный `.exe` (см. ниже)

### Установка зависимостей (из исходников)
```bash
python -m venv .venv
.venv\Scripts\activate  # Windows
pip install --upgrade pip
pip install PySide6 requests pywikibot
```

### Запуск
- Из исходников:
```bash
python -m wiki_cat_tool
```
- Готовый бинарник Windows: `dist/WikiCatTool.exe` (или из раздела Releases вашего репозитория).

## Форматы входных TSV

Общая идея: первая колонка — заголовок страницы. Все последующие колонки склеиваются переводами строк в итоговый текст.

### Для «Перезапись» и «Создание»
```text
Title\tСтрока 1\tСтрока 2\t...  # одна строка TSV = одна страница
```
- Кодировка: рекомендуется UTF‑8 с BOM (совместимо с Excel/LibreOffice).
- Пустая колонка добавляет пустую строку в текст.

### Для «Переименование»
```text
OldTitle\tNewTitle\tКомментарий  # одна строка = одно переименование/перенос
```
- Комментарий из 3‑й колонки опционален. Поле «Комментарий к правке» во вкладке может его переопределить для всех строк.

## Обзор вкладок

### Авторизация
- Введите логин/пароль, выберите язык (например, `ru`) и проект (`wikipedia`, `commons`, и т.д.).
- Кнопка «Обновить префиксы» принудительно перезагрузит локальные префиксы NS для выбранных проекта/языка.
- Данные pywikibot сохраняются в `configs/` рядом с приложением и переиспользуются.

### Чтение
- Источник: список из поля или `.txt` файл (по одной странице в строке).
- «Префиксы»: выберите «Авто» или конкретный NS — заголовки будут нормализованы к выбранному пространству имён (локальные префиксы подтягиваются из API/кэша). Английские префиксы в исходных данных распознаются.
- «Получить подкатегории»: по категории загрузит список подкатегорий через API; Ctrl+клик — откроет готовый запрос в PetScan.
- Результат сохраняется в `.tsv` (UTF‑8 с BOM).

### Перезапись
- Выберите TSV с форматом «Title<TAB>строки…» и нажмите «Предпросмотр» — слева заголовки, справа итоговый контент.
- Укажите «Префиксы» (нормализация заголовков) и «Комментарий к правкам» (общий summary), при необходимости «Малая правка».
- Нажмите «Заменить» для запуска; работает прогресс и лог. Можно остановить.

### Создание
- Аналогично «Перезапись», но создаёт только отсутствующие страницы (существующие пропускаются и отмечаются в логе). «Малая правка» при создании не используется.

### Переименование
- TSV формата `OldTitle<TAB>NewTitle<TAB>Комментарий`.
- Опции:
  - «Переименовывать страницы» и «Оставлять перенаправления» отдельно для категорий и остальных страниц.
  - Перенос содержимого категорий: 
    1) «Обычное перемещение содержимого» — меняет прямые включения `[[Категория:Старая|Ключ]] → [[Категория:Новая|Ключ]]`.
    2) «Через параметры шаблонов» — ищет и правит значения параметров, содержащие имя категории. Для частичных/неоднозначных случаев — диалог подтверждения с предпросмотром и возможностью редактирования.
  - «Фильтр содержимого категории по заголовкам» — RegEx для отбора участников категории (на переименование из TSV не влияет).
- «Показать правила замен»/«Очистить правила» работают с `configs/template_rules.json`.

## Отладка и лог
- Кнопка «Debug» открывает отдельное окно с логом.
- В логе отображаются статусы операций, ошибки и сообщения `PYWIKIBOT:` (диагностика авторизации/HTTP).
- Цветовые статусы и краткие сообщения помогают быстро понять результат по каждой странице.

## Правила шаблонов (template rules)
- Файл: `configs/template_rules.json` (создаётся автоматически при первых сохранениях/нажатиях кнопок во вкладке «Переименование»).
- Содержит независимые правила для каждого шаблона (именованные/позиционные параметры, последовательности), а также автоматизацию: 
  - `auto: approve` — применить автоматически без диалога;
  - `auto: skip` — пропускать автоматически;
  - `auto: none` — подтверждать вручную.
- Команды во вкладке: «Показать правила замен» — открыть файл в системе; «Очистить правила» — обнулить кэш и файл.

## Пространства имён и префиксы
- «Авто» — заголовки не меняются; инструмент корректно распознаёт локальные и английские префиксы.
- При выборе конкретного NS заголовки нормализуются к локальному первичному префиксу, подгружаемому из API (кэшируется на диск в `configs/apicache/ns_<family>_<lang>.json`).
- Принудительное обновление — кнопка «Обновить префиксы» во вкладке «Авторизация».

## Конфигурация и данные
- Папка `configs/` располагается рядом с исполняемым файлом (`.exe`) или пакетом (при запуске из исходников). Внутри:
  - `user-config.py`, `user-password.py` — настройки/пароль pywikibot (пароль хранится в открытом виде, учитывайте безопасность окружения).
  - `pywikibot-<username>.lwp` / `pywikibot.lwp` — куки для сессий авторизации.
  - `throttle.ctrl` — служебный файл pywikibot.
  - `template_rules.json` — правила замен шаблонов.
  - `apicache/` — кэш префиксов пространств имён и другие вспомогательные JSONы.

## Политика запросов и устойчивость
- Все HTTP‑запросы выполняются через общую `requests.Session`.
- Минимальный интервал между запросами и экспоненциальное замедление (backoff) при HTTP 429.
- Операции сохранения используют собственные повторы и интервалы, чтобы снижать риск rate‑limit.

## Сборка Windows‑бинарника
Готовый `.spec` уже в репозитории: `WikiCatTool.spec`.

```bash
pip install pyinstaller
pyinstaller WikiCatTool.spec
# результат: dist/WikiCatTool.exe
```

Альтернатива без spec (упрощённо):
```bash
pyinstaller -F -w -i icon.ico -n WikiCatTool wiki_cat_tool/main.py
```

## Поддерживаемые проекты и языки
- Языки по умолчанию в UI: `ru`, `uk`, `be`, `en`, `fr`, `es`, `de` (можно ввести другой код вручную).
- Семейства: `wikipedia`, `commons`, `wikibooks`, `wikinews`, `wikiquote`, `wikisource`, `wikiversity`, `wikivoyage`, `wiktionary`, `wikidata`, `meta`, `species`, `incubator`, `mediawiki`, `wikifunctions`.

## Советы и примечания
- При ответах API 429/таймаутах инструмент автоматически делает паузы и повторяет запросы.
- Для корректности правок убедитесь, что у вашего аккаунта есть необходимые права/флаги на соответствующем проекте.
- Авторизуясь, вы соглашаетесь с правилами использования Wikimedia и локальными правилами конкретного проекта. Все действия — на вашей ответственности.

## Ограничения и дисклеймер
- Ответственность за массовые изменения несёт оператор; соблюдайте правила локальных сообществ.
- Для некоторых проектов/языков локальные префиксы и поведение страниц допусков могут отличаться; проверяйте логи и тестируйте на малых выборках.
- Вне Wikipedia функциональность протестирована частично.

## Структура проекта (вкратце)
- `gui/` — окно и вкладки UI, диалоги, виджеты.
- `workers/` — фоновые потоки для операций (чтение/перезапись/создание/переименование).
- `core/` — клиент API, менеджеры пространств имён/шаблонов, конфигурация pywikibot.
- `configs/` — конфиги, кэш и правила (создаётся автоматически рядом с приложением).
- `dist/` — сборки (`WikiCatTool.exe`, если выполнялась сборка).

## Разработка
```bash
git clone <ваш-репозиторий>
cd wiki_cat_tool
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt  # при наличии
# либо вручную: pip install PySide6 requests pywikibot
python -m wiki_cat_tool
```

## Лицензия
Лицензия: GPL‑3.0‑or‑later (рекомендуется). Добавьте файл LICENSE в репозиторий. Учитывайте условия сторонних компонентов (например, PySide6/Qt — LGPL‑3.0). Если вы форк, укажите лицензию исходного проекта.

